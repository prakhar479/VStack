services:
  # Metadata Service - Coordination layer
  metadata-service:
    build:
      context: .
      dockerfile: metadata-service/Dockerfile
    container_name: vstack-metadata-service
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DATABASE_URL=/data/metadata.db
      - LOG_LEVEL=INFO
      - HEARTBEAT_INTERVAL=10
      - NODE_TIMEOUT=30
      - POPULARITY_THRESHOLD=1000
      - STORAGE_NODES=http://storage-node-1:8081,http://storage-node-2:8081,http://storage-node-3:8081
    volumes:
      - metadata_data:/data
      - ./metadata-service:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      vstack-network:
        aliases:
          - metadata-service
    restart: unless-stopped

  # Storage Node 1
  storage-node-1:
    build:
      context: .
      dockerfile: storage-node/Dockerfile
    container_name: vstack-storage-node-1
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - NODE_ID=storage-node-1
      - NODE_URL=http://storage-node-1:8081
      - DATA_DIR=/data
      - METADATA_SERVICE_URL=http://metadata-service:8080
      - LOG_LEVEL=INFO
      - MAX_SUPERBLOCK_SIZE=1073741824
    volumes:
      - storage_node_1_data:/data
      - ./storage-node:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      vstack-network:
        aliases:
          - storage-node-1
    depends_on:
      metadata-service:
        condition: service_healthy
    restart: unless-stopped

  # Storage Node 2
  storage-node-2:
    build:
      context: .
      dockerfile: storage-node/Dockerfile
    container_name: vstack-storage-node-2
    ports:
      - "8082:8081"
    environment:
      - PORT=8081
      - NODE_ID=storage-node-2
      - NODE_URL=http://storage-node-2:8081
      - DATA_DIR=/data
      - METADATA_SERVICE_URL=http://metadata-service:8080
      - LOG_LEVEL=INFO
      - MAX_SUPERBLOCK_SIZE=1073741824
    volumes:
      - storage_node_2_data:/data
      - ./storage-node:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      vstack-network:
        aliases:
          - storage-node-2
    depends_on:
      metadata-service:
        condition: service_healthy
    restart: unless-stopped

  # Storage Node 3
  storage-node-3:
    build:
      context: .
      dockerfile: storage-node/Dockerfile
    container_name: vstack-storage-node-3
    ports:
      - "8083:8081"
    environment:
      - PORT=8081
      - NODE_ID=storage-node-3
      - NODE_URL=http://storage-node-3:8081
      - DATA_DIR=/data
      - METADATA_SERVICE_URL=http://metadata-service:8080
      - LOG_LEVEL=INFO
      - MAX_SUPERBLOCK_SIZE=1073741824
    volumes:
      - storage_node_3_data:/data
      - ./storage-node:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      vstack-network:
        aliases:
          - storage-node-3
    depends_on:
      metadata-service:
        condition: service_healthy
    restart: unless-stopped

  # Uploader Service
  uploader-service:
    build:
      context: .
      dockerfile: uploader/Dockerfile
    container_name: vstack-uploader-service
    ports:
      - "8084:8082"
    environment:
      - PORT=8082
      - METADATA_SERVICE_URL=http://metadata-service:8080
      - STORAGE_NODES=http://storage-node-1:8081,http://storage-node-2:8081,http://storage-node-3:8081
      - LOG_LEVEL=INFO
      - CHUNK_SIZE=2097152
      - CHUNK_DURATION=10
      - MAX_CONCURRENT_UPLOADS=5
      - TEMP_DIR=/tmp/uploads
    volumes:
      - upload_temp:/tmp/uploads
      - ./uploader:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      vstack-network:
        aliases:
          - uploader-service
    depends_on:
      metadata-service:
        condition: service_healthy
      storage-node-1:
        condition: service_healthy
      storage-node-2:
        condition: service_healthy
      storage-node-3:
        condition: service_healthy
    restart: unless-stopped

  # Smart Client Dashboard
  smart-client:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: vstack-smart-client
    ports:
      - "8086:8083"
    environment:
      - PORT=8083
      - METADATA_SERVICE_URL=http://metadata-service:8080
      - STORAGE_NODES=http://storage-node-1:8081,http://storage-node-2:8081,http://storage-node-3:8081
      - LOG_LEVEL=INFO
      - MONITORING_INTERVAL=3
      - TARGET_BUFFER_SEC=30
      - LOW_WATER_MARK_SEC=15
      - MAX_CONCURRENT_DOWNLOADS=4
    volumes:
      - ./client:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      vstack-network:
        aliases:
          - smart-client
    depends_on:
      metadata-service:
        condition: service_healthy
      storage-node-1:
        condition: service_healthy
      storage-node-2:
        condition: service_healthy
      storage-node-3:
        condition: service_healthy
    restart: unless-stopped

  # Demo Web Interface
  demo:
    build:
      context: .
      dockerfile: demo/Dockerfile
    container_name: vstack-demo
    ports:
      - "8085:80"
    environment:
      - METADATA_SERVICE_URL=http://metadata-service:8080
      - UPLOADER_SERVICE_URL=http://uploader-service:8082
      - CLIENT_DASHBOARD_URL=http://smart-client:8083
    volumes:
      - ./demo:/app
    networks:
      vstack-network:
        aliases:
          - demo
    depends_on:
      metadata-service:
        condition: service_healthy
      uploader-service:
        condition: service_healthy
      smart-client:
        condition: service_healthy
    restart: unless-stopped

volumes:
  metadata_data:
    driver: local
    name: vstack-metadata-data
  storage_node_1_data:
    driver: local
    name: vstack-storage-node-1-data
  storage_node_2_data:
    driver: local
    name: vstack-storage-node-2-data
  storage_node_3_data:
    driver: local
    name: vstack-storage-node-3-data
  upload_temp:
    driver: local
    name: vstack-upload-temp

networks:
  vstack-network:
    driver: bridge
    name: vstack-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1